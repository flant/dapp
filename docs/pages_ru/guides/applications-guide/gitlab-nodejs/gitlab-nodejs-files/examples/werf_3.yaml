project: chat
configVersion: 1
---
image: node
from: node:14-stretch
git:
- add: /node
  to: /app
  stageDependencies:
    install:
    - package.json
ansible:
  beforeInstall:
  - name: Install dependencies
    apt:
      name:
      - tzdata
      - locales
      update_cache: yes
  install:
  - name: npm сi
    shell: npm сi
    args:
      chdir: /app
  setup:
  - name: npm run build
    shell: npm run build
    args:
      chdir: /app
---
image: node_assets
from: nginx:stable-alpine
docker:
  EXPOSE: '80'
import:
- image: node
  add: /app/dist/assets
  to: /usr/share/nginx/html/assets
  after: setup
---
image: python
from: python:3.8-slim
docker:
  WORKDIR: /app
  CMD: ['python', '/app/consumer.py']
git:
- add: '/python'
  to: '/app'
  stageDependencies:
    install:
    - python/requirements.txt
ansible:
  beforeInstall:
  - name: Install dependencies
    apt:
      name:
      - build-essential
      - bash
      - tzdata
      - locales
      - curl
      - vim
      - python3-dev
      - libpq-dev
      update_cache: yes
  install:
  - name: Install pip
    pip:
      executable: pip3
      requirements: /app/requirements.txt