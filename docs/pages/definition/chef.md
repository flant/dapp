---
title: Chef сборщик
sidebar: doc_sidebar
permalink: chef.html
folder: definition
---

### Chef cборщик

Chef сборщик — это тип сборщика, использующий chef рецепты в качестве инструкций для сборки образов. Для организации кода используются cookbook'и:

* один основной [cookbook dapp](#cookbook-приложения);
* один или несколько опциональных [dimod](#dimod).

### Chef dimg

Chef dimg — это dimg собираемый chef сборщиком.

### Chef директория

Chef директория — это директория \<[директория dapp](#директория-dapp)\>/.dapp_chef. Содержит файлы [cookbook dapp](#cookbook-dapp).

### Cookbook dapp

Cookbook dapp — это основной chef cookbook, связанный с [dapp](#dapp), содержащий инструкции сборки образов.

#### Организация файлов

* Обязательные файлы:
  * metadata.rb
  * Berksfile
    * Содержит все зависимости, в т.ч. [модули dimod](#dimod).
  * Berksfile.lock
    * Может отсутствовать в [режиме разработки](#режим-разработки) — будет создан во время выполнения сборки.
* Структура файлов.
  * Атрибуты.
    * Файлы атрибутов не поддерживаются.
    * Хэш normal-атрибутов задается через [Dappfile](#dappfile), см. [chef.attribute](chef_directives.html#chef-attributes), [chef.\<стадия\>\_attribute](chef_directives.html#chef-<стадия>_attributes).
  * Файлы.
    * Директория files/\<стадия\>/\<рецепт\> — содержит файлы рецепта для стадии, опциональна.
    * Директория files/\<стадия\>/common — содержит общие файлы для стадии, опциональна.
    * Недопустимо наличие одинаковых имен файлов в директории рецепта и common.
  * Шаблоны.
    * Директория templates/\<стадия\>/\<рецепт\> — содержит файлы шаблонов рецепта для стадии, опциональна.
    * Директория templates/\<стадия\>/common — содержит общие файлы шаблонов для стадии, опциональна.
    * Недопустимо наличие одинаковых имен файлов в директории рецепта и common.
  * Рецепты.
    * Директория recipes/\<стадия\> — содержит файлы рецептов для стадии, опциональна.

### Dimod

Dimod — это модуль dimg.

* Дополнительный chef cookbook, который подключается к сборке [chef dimg](#chef-dimg).
* Имя cookbook'а должно начинаться с префикса 'dimod-'.

#### Включение в dapp

Фактически dimod может находится:

* В отдельном месте в файловой системе.
* В отдельном git-репозитории.
* В chef supermarket.

Чтобы подключить модуль к проекту, надо:

* добавить cookbook модуля в Berksfile, находящийся в [chef директории](#chef-директория);
* включить модуль в [Dappfile](#Dappfile) директивой chef.dimod.

#### Организация файлов

Все файлы описанные далее файлы должны находится в [chef директории dapp](#chef-директория).

* Обязательные файлы:
  * metadata.rb
* Структура файлов.
  * Атрибуты.
    * Файл attributes/\<стадия\>.rb — содержит атрибуты для стадии, опционален.
    * Файл attributes/common.rb — содержит атрибуты для всех стадий.
  * Файлы.
    * Директория files/\<стадия\> — содержит файлы, доступные для стадии, опциональна.
    * Директория files/common — содержит файлы, доступные для всех стадий, опциональна.
    * Недопустимо наличие одинаковых имен файлов в директории стадии и common.
  * Шаблоны.
    * Директория template/\<стадия\> — содержит файлы, доступные для стадии, опциональна.
    * Директория template/common — содержит файлы, доступные для всех стадий, опциональна.
    * Недопустимо наличие одинаковых имен файлов в директории стадии и common.
  * Рецепты.
    * Файл recipes/\<стадия\>.rb — файл рецепта модуля для стадии, опционален.

### Стадия cookbook'а

Стадия cookbook'а — это часть cookbook'а, которая используется при сборке стадии для cookbook'а приложения и модулей dimod.

* Понятие применимо только к cookbook'у приложения и модулям dimod.
* Для всех остальных cookbook'ов при сборке стадии используется все файлы cookbook'а без изменений в файлововй структуре.

### Установка стадии cookbook'а
Установка стадии cookbook'а — это процесс копирования файлов стадии cookbook'а во [временное хранилище](#временная-директория-приложения), подключаемое в дальнейшем в контейнер для сборки стадии.

* Установка [cookbook'а приложения](#cookbook-приложения).
  * Атрибуты.
    * Хэш атрибутов, совмещенных из [chef.attribute](chef_directives.html#chef-attributes) и [chef.\<стадия\>\_attribute](chef_directives.html#chef-<стадия>_attributes), устанавливается в normal-атрибуты, передаваемые через JSON-файл.
    * Файлы атрибутов не поддерживаются.
  * Файлы.
    * Содержимое директории files/\<стадия\>/common при наличии устанавливается в директорию files/default.
    * Содержимое директории files/\<стадия\>/\<рецепт\> устанавливается в директорию files/default.
      * Для каждого включенного рецепта при наличии соответствующей директории.
    * Недопустимо наличие одинаковых имен файлов в директории рецепта и common.
  * Шаблоны.
    * Содержимое директории templates/\<стадия\>/common при наличии устанавливается в директорию templates/default.
    * Содержимое директории templates/\<стадия\>/\<рецепт\> устанавливается в директорию templates/default.
      * Для каждого включенного рецепта при наличии соответствующей директории.
    * Недопустимо наличие одинаковых имен файлов в директории рецепта и common.
  * Рецепты.
    * Файл recipes/\<стадия\>/\<рецепт\>.rb устанавливается в recipes/\<рецепт\>.rb.
      * Для каждого включенного рецепта при его наличии.
    * При отсутствии рецептов генерируется пустой рецепт recipes/void.rb.
      * Отсутствие рецептов подразумевает одно из условий:
        * отсутствие включенных рецептов в конфигурации;
        * отсутствие файлов рецептов (recipes/\<стадия\>/\<рецепт\>.rb) для всех включенных в конфигурации рецептов.
      * Это позволяет активировать атрибуты, объявленные в данном cookbook'е.
* Установка [dimod](#dimod).
  * Атрибуты.
    * Файл attributes/\<стадия\>.rb устанавливается в attributes/\<стадия\>.rb.
    * Файл attributes/common.rb устанавливается в attributes/common.rb.
  * Файлы.
    * Содержимое директории files/common при наличии устанавливается в директорию files/default.
    * Содержимое директории files/\<стадия\> при наличии устанавливается в директорию files/default.
    * Недопустимо наличие одинаковых имен файлов в директории стадии и common.
  * Шаблоны.
    * Содержимое директории templates/common при наличии устанавливается в директорию templates/default.
    * Содержимое директории templates/\<стадия\> при наличии устанавливается в директорию templates/default.
    * Недопустимо наличие одинаковых имен файлов в директории стадии и common.
  * Рецепты.
    * Файл recipes/\<стадия\>.rb при наличии устанавливается в recipes/\<стадия\>.rb.
    * При отсутствии рецепта генерируется пустой рецепт recipes/void.rb.
      * Это позволяет активировать атрибуты, объявленные в данном cookbook'е, при отсутствии рецепта.
* Остальныe cookbook'и устанавливаются без изменений, "как есть".

### Контрольная сумма cookbook'ов стадии
Контрольная сумма cookbook'ов стадии — это контрольная сумма всех [установленных файлов cookbook'ов](#установка-стадии-cookbookа) для данной стадии.

### Дерево cookbooks
Дерево cookbooks — это результат выполнения berks vendor в chef приложении.
